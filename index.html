<!DOCTYPE html>
<html lang="fa" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="تبدیل متن به صوت حرفه‌ای با هوش مصنوعی جمینی">
    <title>جمینی Voice Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { dark: { bg: '#0f172a', card: '#1e293b', input: '#334155', text: '#f1f5f9' } },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'bounce-x': 'bounceX 1s infinite' },
                    keyframes: { bounceX: { '0%, 100%': { transform: 'translateX(-25%)' }, '50%': { transform: 'translateX(0)' } } }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .gradient-text { background: linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #ffffff; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader-dark { border-color: rgba(99, 102, 241, 0.2); border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #475569; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-0 md:p-4 bg-gray-50 dark:bg-dark-bg transition-colors duration-300">

    <div class="w-full max-w-md h-screen md:h-auto md:max-h-[95vh] bg-white dark:bg-dark-card md:rounded-[2rem] shadow-none md:shadow-2xl overflow-hidden relative transition-colors duration-300 border-none md:border border-gray-200 dark:border-gray-700 flex flex-col">
        
        <!-- Header -->
        <div class="bg-white/80 dark:bg-dark-card/90 backdrop-blur-md p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center z-20 shrink-0 sticky top-0">
            <div>
                <h1 class="text-lg font-black text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-wave-square text-indigo-500"></i>
                    جمینی <span class="gradient-text">Voice Pro</span>
                </h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400 w-9 h-9 flex items-center justify-center">
                    <i id="themeIcon" class="fa-solid fa-moon"></i>
                </button>
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400 w-9 h-9 flex items-center justify-center relative">
                    <i class="fa-solid fa-gear text-lg"></i>
                    <span id="noKeyBadge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full animate-pulse hidden"></span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scroll pb-24">
            
            <!-- Tone Section -->
            <div class="space-y-3 relative group">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-masks-theater text-pink-500"></i> لحن و سبک
                    </label>
                    <span class="text-[10px] text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-full">دستور کوتاه (انگلیسی) بهتر است</span>
                </div>
                
                <div class="flex gap-2 relative">
                    <input type="text" id="toneInput" placeholder="مثلاً: Sad, Slow..." 
                        class="flex-1 p-3 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none transition text-sm font-mono dir-ltr placeholder:font-sans placeholder:dir-rtl text-left">
                    
                    <button onclick="enhanceTone()" id="enhanceBtn" class="bg-indigo-500 text-white w-12 rounded-xl shadow-lg shadow-indigo-500/30 hover:bg-indigo-600 active:scale-95 transition flex items-center justify-center" title="بهینه‌سازی دستور لحن برای هوش مصنوعی">
                        <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                        <div id="enhanceLoader" class="loader hidden"></div>
                    </button>
                </div>

                <!-- Tone Presets -->
                <div class="relative">
                    <div class="flex gap-2 overflow-x-auto pb-2 pt-1 hide-scroll relative z-10 snap-x" id="tonePresets"></div>
                    <div class="absolute right-0 top-0 bottom-2 w-8 bg-gradient-to-l from-white dark:from-dark-card to-transparent pointer-events-none z-20"></div>
                    <div class="absolute left-0 top-0 bottom-2 w-8 bg-gradient-to-r from-white dark:from-dark-card to-transparent pointer-events-none z-20"></div>
                    <div class="text-[9px] text-gray-400 text-center mt-1 flex items-center justify-center gap-2 opacity-70">
                        <i class="fa-solid fa-chevron-right text-[8px] animate-bounce-x"></i>
                        اسکرول کنید
                        <i class="fa-solid fa-chevron-left text-[8px] animate-bounce-x"></i>
                    </div>
                </div>
            </div>

            <!-- Voice Selection -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                    <i class="fa-solid fa-microphone-lines text-indigo-500"></i> گوینده (۳۰+ مدل)
                </label>
                <div class="relative">
                    <select id="voiceSelect" class="w-full p-3 pl-10 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none appearance-none transition text-sm">
                        <!-- Voices JS -->
                    </select>
                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Main Text Input -->
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-align-right text-green-500"></i> متن ورودی
                    </label>
                    <button onclick="autoDiacritics()" id="diacriticBtn" class="text-[10px] bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 px-2.5 py-1 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/40 transition flex items-center gap-1.5 border border-green-200 dark:border-green-800">
                        <i class="fa-solid fa-spell-check"></i>
                        <span>اصلاح اعراب</span>
                        <div id="diacriticLoader" class="loader loader-dark !border-green-500 !border-t-transparent w-3 h-3 border-2 hidden"></div>
                    </button>
                </div>
                <textarea id="textInput" rows="5" placeholder="متن خود را اینجا بنویسید..." 
                    class="w-full p-4 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none transition resize-none text-base leading-relaxed text-right font-medium" dir="auto"></textarea>
            </div>

            <hr class="border-gray-100 dark:border-gray-700">

            <!-- History Section -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-clock-rotate-left text-orange-500"></i> تاریخچه
                    </label>
                    <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600 transition bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded-lg">
                        <i class="fa-solid fa-trash-can"></i> حذف همه
                    </button>
                </div>
                <div id="historyList" class="space-y-3 pb-4"></div>
            </div>

        </div>

        <!-- Action Bar -->
        <div class="p-4 bg-white/80 dark:bg-dark-card/90 backdrop-blur-md border-t border-gray-100 dark:border-gray-700 shrink-0 z-20">
            <button id="generateBtn" onclick="generateAudio()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/30 dark:shadow-none active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-lg group">
                <span id="btnText">تولید صدا</span>
                <span id="btnIcon" class="group-hover:translate-x-1 transition-transform"><i class="fa-solid fa-play"></i></span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </div>

    </div>

    <!-- Settings Modal (FIXED) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0 px-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform border border-gray-100 dark:border-gray-700 flex flex-col max-h-[85vh]" id="settingsContent">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white">تنظیمات API</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Help Box (Restored) -->
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800 mb-4 shrink-0">
                <div class="flex items-start gap-2">
                    <i class="fa-solid fa-circle-info text-blue-500 mt-0.5 text-xs"></i>
                    <div>
                        <p class="text-xs text-blue-800 dark:text-blue-200 leading-5">
                            کلید API شما در مرورگر خودتان ذخیره می‌شود. برای استفاده نامحدود می‌توانید چند کلید وارد کنید.
                        </p>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[11px] font-bold text-blue-600 dark:text-blue-400 hover:underline mt-1 inline-flex items-center gap-1">
                            دریافت کلید رایگان از گوگل
                            <i class="fa-solid fa-arrow-up-right-from-square text-[9px]"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Key List -->
            <div class="space-y-2 flex-1 overflow-y-auto custom-scroll pr-1 mb-4 border-t border-b border-gray-100 dark:border-gray-700 py-2" id="keyList">
                <!-- Keys will be injected here -->
            </div>

            <!-- Add Key Input -->
            <div class="flex gap-2 shrink-0">
                <input type="text" id="newApiKey" placeholder="کلید جدید..." class="flex-1 p-3 border dark:border-gray-600 dark:bg-dark-input dark:text-white rounded-lg text-sm bg-gray-50 ltr text-left font-mono">
                <button onclick="addApiKey()" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition shadow-md shadow-indigo-500/20">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-xl text-sm shadow-2xl opacity-0 pointer-events-none transition-opacity duration-300 z-50 text-center w-max max-w-[90%] font-medium flex items-center gap-2"></div>

    <script>
        // --- DATA ---
        const VOICES = [
            { name: "Kore", gender: "زن", style: "استاندارد", desc: "پیشنهادی، شفاف" },
            { name: "Zephyr", gender: "مرد", style: "استاندارد", desc: "پیشنهادی، گرم" },
            { name: "Puck", gender: "مرد", style: "استاندارد", desc: "محکم" },
            { name: "Fenrir", gender: "مرد", style: "عمیق", desc: "بسیار بم، تریلر" },
            { name: "Leda", gender: "زن", style: "نرم", desc: "آرام و ملایم" },
            { name: "Aoede", gender: "زن", style: "استاندارد", desc: "رسا و جدی" },
            { name: "Charon", gender: "مرد", style: "عمیق", desc: "خشن" },
            { name: "Orus", gender: "مرد", style: "استاندارد", desc: "عادی" },
            { name: "Callirrhoe", gender: "زن", style: "استاندارد", desc: "شاداب" },
            { name: "Enceladus", gender: "مرد", style: "استاندارد", desc: "اخبار" },
            { name: "Algenib", gender: "مرد", style: "استاندارد", desc: "تند و تیز" },
            { name: "Rasalgethi", gender: "مرد", style: "استاندارد", desc: "مکالمه" },
            { name: "Iapetus", gender: "مرد", style: "استاندارد", desc: "جدی" }
        ];

        // Values are simple adjectives to prevent reading
        const TONE_PRESETS = [
            { label: "عادی", value: "", icon: "fa-regular fa-comment" },
            { label: "رسمی/خبری", value: "Formal, Clear", icon: "fa-solid fa-bullhorn" },
            { label: "کودکانه", value: "Warm, Engaging", icon: "fa-solid fa-book-open" },
            { label: "هیجانی", value: "Excited, Fast", icon: "fa-regular fa-face-laugh-beam" },
            { label: "غمگین", value: "Sad, Slow", icon: "fa-regular fa-face-frown" },
            { label: "زمزمه", value: "Whispering", icon: "fa-solid fa-ear-listen" },
            { label: "حماسی", value: "Deep, Dramatic", icon: "fa-solid fa-film" },
            { label: "رباتیک", value: "Monotone, Flat", icon: "fa-solid fa-robot" },
            { label: "پیرمرد/زن", value: "Shaky, Gravelly", icon: "fa-solid fa-user-clock" }
        ];

        let apiKeys = JSON.parse(localStorage.getItem('gemini_tts_keys') || '[]');
        let currentTheme = localStorage.getItem('gemini_theme') || 'light';
        let db;

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error)); }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
            populateVoiceSelect();
            populateTonePresets();
            renderApiKeys();
            initDB();
            if(apiKeys.length === 0) setTimeout(toggleSettings, 800);
        });

        // --- DB ---
        function initDB() {
            const r = indexedDB.open("GeminiTTSDB", 1);
            r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains("history")) e.target.result.createObjectStore("history", { keyPath: "id" }); };
            r.onsuccess = e => { db = e.target.result; loadHistory(); };
        }

        // --- UI POPULATORS ---
        function populateTonePresets() {
            const container = document.getElementById('tonePresets');
            TONE_PRESETS.forEach(tone => {
                const btn = document.createElement('button');
                btn.className = "snap-start shrink-0 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-[11px] text-gray-600 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition flex items-center gap-2 shadow-sm min-w-[max-content]";
                btn.innerHTML = `<i class="${tone.icon}"></i> ${tone.label}`;
                btn.onclick = () => {
                    const input = document.getElementById('toneInput');
                    input.value = tone.value;
                    input.classList.add('ring-2', 'ring-indigo-500');
                    setTimeout(() => input.classList.remove('ring-2', 'ring-indigo-500'), 300);
                };
                container.appendChild(btn);
            });
            const spacer = document.createElement('div'); spacer.className = "w-4 shrink-0"; container.appendChild(spacer);
        }

        function populateVoiceSelect() {
            const select = document.getElementById('voiceSelect');
            VOICES.forEach(v => {
                const option = document.createElement('option');
                option.value = v.name;
                option.textContent = `${v.name} (${v.desc})`;
                if (v.name === 'Kore') option.selected = true;
                select.appendChild(option);
            });
        }

        // --- API HELPERS ---
        async function getWorkingKey(fn) {
            if (apiKeys.length === 0) { showToast('کلید API را وارد کنید', true); toggleSettings(); return null; }
            for (const key of apiKeys) {
                try { return await fn(key); } catch (e) { console.warn('Key failed, trying next...'); continue; }
            }
            throw new Error('تمام کلیدها با خطا مواجه شدند.');
        }

        // --- TONE ENHANCER (Safe Mode) ---
        async function enhanceTone() {
            const input = document.getElementById('toneInput');
            const text = input.value.trim();
            if (!text) { showToast('توصیفی بنویسید', true); return; }

            const btn = document.getElementById('enhanceBtn');
            const icon = btn.querySelector('i');
            const loader = document.getElementById('enhanceLoader');

            btn.disabled = true; icon.classList.add('hidden'); loader.classList.remove('hidden');

            try {
                const enhancedPrompt = await getWorkingKey(async (key) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    // Strict instruction for adjectives only
                    const prompt = `Convert user description to 3-4 English adjectives for a TTS voice style. NO sentences. Input: "${text}"`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.3 } })
                    });
                    if(!res.ok) throw new Error('API Error');
                    const cand = await res.json();
                    return cand.candidates[0].content.parts[0].text.trim().replace(/\.$/, '');
                });
                if (enhancedPrompt) { input.value = enhancedPrompt; showToast('بهینه شد ✨'); }
            } catch (e) { showToast('خطا: ' + e.message, true); } 
            finally { btn.disabled = false; icon.classList.remove('hidden'); loader.classList.add('hidden'); }
        }

        // --- AUTO DIACRITICS ---
        async function autoDiacritics() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();
            if (!text) { showToast('متن خالی است', true); return; }
            const btn = document.getElementById('diacriticBtn');
            const loader = document.getElementById('diacriticLoader');
            const icon = btn.querySelector('.fa-spell-check');
            btn.disabled = true; icon.classList.add('hidden'); loader.classList.remove('hidden');

            try {
                const resText = await getWorkingKey(async (key) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const prompt = `Add minimal diacritics (harakat) to this Persian text. Kasra for Ezafe is priority. Output ONLY text. Input: ${text}`;
                    const res = await fetch(url, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.1 } })
                    });
                    if(!res.ok) throw new Error('API Error');
                    return (await res.json()).candidates[0].content.parts[0].text.trim();
                });
                if (resText) { textInput.value = resText; showToast('انجام شد'); }
            } catch (e) { showToast(e.message, true); } 
            finally { btn.disabled = false; icon.classList.remove('hidden'); loader.classList.add('hidden'); }
        }

        // --- GENERATE AUDIO ---
        async function generateAudio() {
            const text = document.getElementById('textInput').value.trim();
            const tone = document.getElementById('toneInput').value.trim();
            const voice = document.getElementById('voiceSelect').value;

            if (!text) { showToast('متن را وارد کنید', true); return; }
            setLoading(true);

            // Safe prompt construction
            let prompt = text;
            if (tone) {
                // Using parentheses helps isolate style from content
                prompt = `(Style: ${tone}) ${text}`;
            }

            try {
                await getWorkingKey(async (key) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                        }
                    };
                    const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || res.statusText); }
                    const data = await res.json();
                    const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!audioData) throw new Error("داده صوتی دریافت نشد");
                    processAndSave(audioData, text, tone, voice);
                });
            } catch (e) { showToast(e.message, true); } finally { setLoading(false); }
        }

        function processAndSave(base64, text, tone, voice) {
            const binary = window.atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const wav = pcmToWav(bytes, 24000);
            const blob = new Blob([wav], { type: 'audio/wav' });
            saveToHistory(text, tone, voice, blob);
            showToast('صدا تولید شد');
        }

        // --- HISTORY ---
        function saveToHistory(text, tone, voice, blob) {
            const t = db.transaction(["history"], "readwrite");
            t.objectStore("history").add({ id: Date.now(), text, tone, voice, blob, date: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) });
            t.oncomplete = () => loadHistory();
        }

        function loadHistory() {
            if (!db) return;
            const r = db.transaction(["history"], "readonly").objectStore("history").getAll();
            r.onsuccess = () => {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                const items = r.result.sort((a,b) => b.id - a.id);
                if(items.length === 0) { list.innerHTML = '<div class="text-xs text-gray-400 text-center py-6 opacity-50">تاریخچه خالی است</div>'; return; }
                items.forEach(i => {
                    const url = URL.createObjectURL(i.blob);
                    const div = document.createElement('div');
                    div.className = "bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col gap-2";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 overflow-hidden">
                                <p class="text-xs font-bold text-gray-800 dark:text-gray-200 truncate">${i.text}</p>
                                <p class="text-[10px] text-gray-500 mt-1">${i.voice} | ${i.date}</p>
                            </div>
                            <button onclick="delHist(${i.id})" class="text-gray-300 hover:text-red-500 px-2"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            <audio controls src="${url}" class="h-8 w-full block rounded-lg bg-gray-50 dark:bg-gray-900"></audio>
                            <a href="${url}" download="tts_${i.id}.wav" class="bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 w-8 h-8 flex items-center justify-center rounded-lg"><i class="fa-solid fa-download text-xs"></i></a>
                        </div>`;
                    list.appendChild(div);
                });
            };
        }
        function delHist(id) { if(confirm('حذف شود؟')) { const t = db.transaction(["history"], "readwrite"); t.objectStore("history").delete(id); t.oncomplete = loadHistory; } }
        function clearHistory() { if(confirm('همه پاک شود؟')) { const t = db.transaction(["history"], "readwrite"); t.objectStore("history").clear(); t.oncomplete = loadHistory; } }
        function pcmToWav(pcm, rate) {
            const b = new ArrayBuffer(44 + pcm.length), v = new DataView(b);
            const w = (o,s) => { for(let i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i)); };
            w(0,'RIFF'); v.setUint32(4,36+pcm.length,true); w(8,'WAVE'); w(12,'fmt '); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true); v.setUint32(24,rate,true); v.setUint32(28,rate*2,true); v.setUint16(32,2,true); v.setUint16(34,16,true); w(36,'data'); v.setUint32(40,pcm.length,true); new Uint8Array(b).set(pcm,44); return b;
        }

        // --- SETTINGS LOGIC (FIXED) ---
        function applyTheme(t) { localStorage.setItem('gemini_theme', t); document.documentElement.classList.toggle('dark', t==='dark'); document.getElementById('themeIcon').className = t==='dark' ? 'fa-solid fa-sun text-yellow-400' : 'fa-solid fa-moon'; }
        function toggleTheme() { applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'); }
        function toggleSettings() { const m = document.getElementById('settingsModal'); m.classList.toggle('hidden'); setTimeout(()=> m.classList.toggle('opacity-0'), 10); }
        function showToast(m,e) { const t=document.getElementById('toast'); t.innerHTML = (e?'<i class="fa-solid fa-circle-exclamation text-red-300"></i> ':'<i class="fa-solid fa-circle-check text-green-300"></i> ')+m; t.className = `fixed bottom-24 left-1/2 -translate-x-1/2 px-5 py-3 rounded-xl text-sm shadow-2xl z-50 flex items-center gap-2 font-medium transition-all duration-300 ${e?'bg-red-600 text-white':'bg-gray-800 text-white'}`; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',3000); }
        
        function renderApiKeys() { 
            const l=document.getElementById('keyList'); 
            l.innerHTML=''; 
            
            if (apiKeys.length === 0) {
                l.innerHTML = '<div class="text-center text-gray-400 text-xs py-4">هنوز کلیدی وارد نشده است</div>';
            }

            apiKeys.forEach((k,i)=>{ 
                const d=document.createElement('div'); 
                d.className='flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg border border-gray-100 dark:border-gray-600'; 
                d.innerHTML=`
                    <div class="flex-1 overflow-hidden mr-2 relative">
                        <input type="password" id="key-${i}" value="${k}" readonly class="w-full bg-transparent border-none outline-none text-[10px] font-mono text-gray-600 dark:text-gray-300 h-6">
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleVis(${i})" class="text-gray-400 hover:text-indigo-500 p-1.5 rounded"><i id="eye-${i}" class="fa-solid fa-eye"></i></button>
                        <button onclick="copyKey('${k}')" class="text-gray-400 hover:text-green-500 p-1.5 rounded"><i class="fa-regular fa-copy"></i></button>
                        <button onclick="rmKey(${i})" class="text-red-300 hover:text-red-500 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button>
                    </div>`; 
                l.appendChild(d); 
            }); 
            document.getElementById('noKeyBadge').classList.toggle('hidden', apiKeys.length>0); 
        }

        function toggleVis(i) { const inp=document.getElementById(`key-${i}`), ic=document.getElementById(`eye-${i}`); if(inp.type==='password'){inp.type='text';ic.className='fa-solid fa-eye-slash';}else{inp.type='password';ic.className='fa-solid fa-eye';} }
        function copyKey(k) { navigator.clipboard.writeText(k).then(()=>showToast('کپی شد')); }
        
        function addApiKey() { 
            const input = document.getElementById('newApiKey');
            const v = input.value.trim(); 
            if(v){
                apiKeys.push(v); 
                localStorage.setItem('gemini_tts_keys',JSON.stringify(apiKeys)); 
                input.value=''; 
                renderApiKeys(); 
                showToast('ذخیره شد');
            } 
        }
        
        function rmKey(i) { 
            if(confirm('حذف شود؟')){
                apiKeys.splice(i,1); 
                localStorage.setItem('gemini_tts_keys',JSON.stringify(apiKeys)); 
                renderApiKeys();
            } 
        }

        function setLoading(l) { const b=document.getElementById('generateBtn'); if(l){b.disabled=true;b.classList.add('opacity-75');document.getElementById('btnText').textContent='';document.getElementById('btnIcon').classList.add('hidden');document.getElementById('btnLoader').classList.remove('hidden');}else{b.disabled=false;b.classList.remove('opacity-75');document.getElementById('btnText').textContent='تولید صدا';document.getElementById('btnIcon').classList.remove('hidden');document.getElementById('btnLoader').classList.add('hidden');}}
    </script>
</body>
</html>


