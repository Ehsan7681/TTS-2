<!DOCTYPE html>
<html lang="fa" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ ØµÙˆØª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¬Ù…ÛŒÙ†ÛŒ">
    <title>Ø¬Ù…ÛŒÙ†ÛŒ Voice Studio Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { dark: { bg: '#0f172a', card: '#1e293b', input: '#334155', text: '#f1f5f9' } },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .gradient-text { background: linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #ffffff; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        .loader-dark { border-color: rgba(99, 102, 241, 0.2); border-top-color: #6366f1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #475569; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #6366f1; margin-top: -5px; box-shadow: 0 0 5px rgba(0,0,0,0.2); transition: transform 0.1s; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #475569; }

        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 400px; opacity: 1; }

        /* Karaoke Highlight */
        .karaoke-active {
            background-color: rgba(99, 102, 241, 0.1);
            border-right: 3px solid #6366f1;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }
        .dark .karaoke-active {
            background-color: rgba(99, 102, 241, 0.2);
        }
        
        /* New Badge Style for Roles */
        .role-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .dark .role-badge {
            background-color: #312e81;
            color: #c7d2fe;
            border-color: #4338ca;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-0 md:p-4 bg-gray-50 dark:bg-dark-bg transition-colors duration-300">

    <div class="w-full max-w-md h-screen md:h-auto md:max-h-[95vh] bg-white dark:bg-dark-card md:rounded-[2rem] shadow-none md:shadow-2xl overflow-hidden relative transition-colors duration-300 border-none md:border border-gray-200 dark:border-gray-700 flex flex-col">
        
        <!-- Header -->
        <div class="bg-white/80 dark:bg-dark-card/90 backdrop-blur-md p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center z-20 shrink-0 sticky top-0">
            <div>
                <h1 class="text-lg font-black text-gray-800 dark:text-white flex items-center gap-2">
                    <div class="bg-indigo-100 dark:bg-indigo-900/30 p-1.5 rounded-lg text-indigo-600">
                        <i class="fa-solid fa-microphone-lines"></i>
                    </div>
                    Ø¬Ù…ÛŒÙ†ÛŒ <span class="gradient-text">Studio Pro</span>
                </h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400 w-9 h-9 flex items-center justify-center">
                    <i id="themeIcon" class="fa-solid fa-moon"></i>
                </button>
                <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-500 dark:text-gray-400 w-9 h-9 flex items-center justify-center relative">
                    <i class="fa-solid fa-gear text-lg"></i>
                    <span id="noKeyBadge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full animate-pulse hidden"></span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scroll pb-32">
            
            <!-- Mode Switcher -->
            <div class="bg-gray-50 dark:bg-dark-input p-1 rounded-xl flex relative">
                <div id="modeIndicator" class="absolute top-1 bottom-1 w-[48%] bg-white dark:bg-gray-600 rounded-lg shadow-sm transition-all duration-300 right-1"></div>
                <button onclick="setMode('single')" class="flex-1 py-2 text-xs font-bold text-center z-10 transition-colors duration-300 flex items-center justify-center gap-2 relative" id="modeBtn-single">
                    <i class="fa-solid fa-user"></i> ØªÚ©â€ŒÚ¯ÙˆÛŒÙ†Ø¯Ù‡
                </button>
                <button onclick="setMode('multi')" class="flex-1 py-2 text-xs font-bold text-center z-10 transition-colors duration-300 flex items-center justify-center gap-2 relative" id="modeBtn-multi">
                    <i class="fa-solid fa-users-rays"></i> Ø³Ù†Ø§Ø±ÛŒÙˆ/Ú†Ù†Ø¯Ú¯ÙˆÛŒÙ†Ø¯Ù‡
                </button>
            </div>

            <!-- Voice Selection (Only visible in Single Mode) -->
            <div id="singleVoiceContainer" class="space-y-2 transition-all duration-300">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                    <i class="fa-solid fa-microphone text-indigo-500"></i> Ú¯ÙˆÛŒÙ†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                </label>
                <button type="button" onclick="toggleVoiceList()" class="w-full bg-white dark:bg-dark-input border border-gray-200 dark:border-gray-600 p-3 rounded-xl flex justify-between items-center transition hover:border-indigo-400 group">
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-start">
                            <span id="selectedVoiceName" class="text-sm font-bold text-gray-700 dark:text-gray-200 font-mono">Kore</span>
                            <span class="text-[10px] text-gray-400" id="selectedVoiceDesc">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒØŒ Ø´ÙØ§Ù</span>
                        </div>
                    </div>
                    <i id="voiceArrow" class="fa-solid fa-chevron-down text-gray-400 transition-transform"></i>
                </button>
                <div id="voiceListContainer" class="accordion-content bg-gray-50 dark:bg-dark-input border-x border-b border-gray-200 dark:border-gray-600 rounded-b-xl -mt-1 z-10 relative">
                    <div class="p-2 overflow-y-auto custom-scroll max-h-[250px] space-y-1.5" id="voiceListInner"></div>
                </div>
                <input type="hidden" id="voiceSelect" value="Kore">
            </div>

            <div id="multiInfo" class="hidden p-3 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl text-xs text-indigo-700 dark:text-indigo-300 flex items-start gap-2">
                <i class="fa-solid fa-info-circle mt-0.5"></i>
                <p>Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ú¯ÙˆÛŒÙ†Ø¯Ù‡ØŒ Ù„Ø­Ù† Ùˆ Ø³Ø¨Ú© Ù…Ø¬Ø²Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯.</p>
            </div>

            <!-- Tone Section (Global) -->
            <div class="space-y-3 relative group" id="globalToneSection">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-masks-theater text-pink-500"></i> Ù„Ø­Ù† Ú©Ù„ÛŒ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)
                    </label>
                </div>
                <div class="flex gap-2 relative">
                    <input type="text" id="toneInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Sad, Slow..." 
                        class="flex-1 p-3 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none transition text-sm font-mono dir-ltr placeholder:font-sans placeholder:dir-rtl text-left">
                    <button onclick="enhanceTone()" id="enhanceBtn" class="bg-indigo-500 text-white w-12 rounded-xl shadow-lg shadow-indigo-500/30 hover:bg-indigo-600 active:scale-95 transition flex items-center justify-center" title="Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÙˆØ± Ù„Ø­Ù†">
                        <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                        <div id="enhanceLoader" class="loader hidden"></div>
                    </button>
                </div>
                <div class="relative">
                    <div class="flex gap-2 overflow-x-auto pb-2 pt-1 hide-scroll relative z-10 snap-x" id="tonePresets"></div>
                </div>
            </div>

            <!-- Main Text Input -->
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-align-right text-green-500"></i> Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒ
                    </label>
                    <div class="flex gap-2">
                         <span id="charCount" class="text-[10px] text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-md">0 Ú©Ø§Ø±Ø§Ú©ØªØ± | 0 Ú©Ù„Ù…Ù‡</span>
                    </div>
                </div>
                
                <div class="relative">
                    <textarea id="textInput" rows="6" oninput="updateCounts()" placeholder="Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                        class="w-full p-4 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none transition resize-none text-base leading-relaxed text-right font-medium" dir="auto"></textarea>
                    
                    <!-- Text Tools -->
                    <div class="absolute bottom-3 left-3 flex gap-2">
                        <button onclick="openScriptWizard()" class="text-[10px] bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 px-2.5 py-1.5 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/60 transition flex items-center gap-1.5 shadow-sm">
                            <i class="fa-solid fa-hat-wizard"></i>
                            <span>Ø³Ù†Ø§Ø±ÛŒÙˆ Ù†ÙˆÛŒØ³</span>
                        </button>
                        <button onclick="autoDiacritics()" id="diacriticBtn" class="text-[10px] bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300 px-2.5 py-1.5 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/60 transition flex items-center gap-1.5 shadow-sm">
                            <i class="fa-solid fa-spell-check"></i>
                            <span>Ø§ØµÙ„Ø§Ø­ Ø§Ø¹Ø±Ø§Ø¨</span>
                            <div id="diacriticLoader" class="loader loader-dark !border-green-500 !border-t-transparent w-3 h-3 border-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>

            <hr class="border-gray-100 dark:border-gray-700">

            <!-- History Section -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide flex items-center gap-1">
                        <i class="fa-solid fa-clock-rotate-left text-orange-500"></i> Ø§Ø³ØªÙˆØ¯ÛŒÙˆ (Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±)
                    </label>
                    <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600 transition bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded-lg">
                        <i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù Ù‡Ù…Ù‡
                    </button>
                </div>
                <div id="historyList" class="space-y-4 pb-4"></div>
            </div>

        </div>

        <!-- Action Bar -->
        <div class="p-4 bg-white/80 dark:bg-dark-card/90 backdrop-blur-md border-t border-gray-100 dark:border-gray-700 shrink-0 z-20 sticky bottom-0">
            <button id="prepareBtn" onclick="prepareGeneration()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/30 dark:shadow-none active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-lg group">
                <span id="btnText">Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§</span>
                <span id="btnIcon" class="group-hover:translate-x-1 transition-transform"><i class="fa-solid fa-layer-group"></i></span>
            </button>
        </div>

    </div>

    <!-- Chunk Editor Modal (Advanced) -->
    <div id="chunkModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0 px-2 md:px-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-lg h-[90vh] rounded-2xl p-0 shadow-2xl transform scale-95 transition-transform border border-gray-100 dark:border-gray-700 flex flex-col overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-dark-input flex justify-between items-center shrink-0">
                <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-indigo-500"></i>
                    ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯Ø§Ø³ØªØ§Ù† Ùˆ Ú¯ÙˆÛŒÙ†Ø¯Ú¯Ø§Ù†
                </h3>
                <button onclick="closeChunkModal()" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-500 dark:text-gray-300 flex items-center justify-center hover:bg-red-100 hover:text-red-500 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Smart Splitter Section -->
            <div class="p-3 bg-indigo-50 dark:bg-indigo-900/10 border-b border-indigo-100 dark:border-indigo-800 shrink-0">
                <button onclick="smartSplitStory()" id="smartSplitBtn" class="w-full bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/60 border border-indigo-200 dark:border-indigo-800 py-2 rounded-xl transition flex items-center justify-center gap-2 text-sm font-bold shadow-sm relative overflow-hidden group">
                    <span class="relative z-10 flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-pink-500"></i>
                        Ø¢Ù†Ø§Ù„ÛŒØ² Ùˆ ØªÙÚ©ÛŒÚ© Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø§Ø³ØªØ§Ù† (AI)
                    </span>
                    <div id="smartLoader" class="hidden absolute inset-0 bg-indigo-50/80 dark:bg-indigo-900/80 flex items-center justify-center z-20 backdrop-blur-sm">
                        <div class="loader !border-indigo-500 !border-t-transparent w-5 h-5"></div>
                    </div>
                </button>
            </div>

            <div class="p-4 bg-white dark:bg-dark-card border-b border-gray-100 dark:border-gray-700 shrink-0">
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                        <span>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø®Ø´â€ŒÙ‡Ø§ (Ø¯Ø³ØªÛŒ): <b id="chunkCountDisplay" class="text-indigo-600 text-sm">Auto</b></span>
                        <input type="range" id="chunkSlider" min="1" max="20" value="1" class="w-40" oninput="updateChunkingFromSlider(this.value)">
                    </div>
                </div>
            </div>
            <div id="chunksContainer" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll bg-gray-100 dark:bg-black/20"></div>
            <div class="p-4 bg-white dark:bg-dark-card border-t border-gray-100 dark:border-gray-700 shrink-0 flex gap-3">
                <button onclick="startJobInUI()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 active:scale-95 transition flex items-center justify-center gap-2">
                    <span>ØªÙˆÙ„ÛŒØ¯ ØµØ¯Ø§</span>
                    <i class="fa-solid fa-check-double"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Script Wizard Modal -->
    <div id="scriptModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0 px-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform border border-gray-100 dark:border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-hat-wizard text-purple-500"></i> Ø¬Ø§Ø¯ÙˆÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆ</h2>
                <button onclick="closeScriptModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Ù…ÙˆØ¶ÙˆØ¹ ÛŒØ§ Ø§ÛŒØ¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ø­Ø« Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†)</label>
                    <textarea id="scriptTopic" rows="3" class="w-full p-3 bg-gray-50 dark:bg-dark-input dark:text-white rounded-xl border border-gray-200 dark:border-gray-600 text-sm"></textarea>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§</label>
                        <select id="scriptActors" class="w-full p-2 bg-gray-50 dark:bg-dark-input dark:text-white rounded-lg border border-gray-200 dark:border-gray-600 text-sm">
                            <option value="2">2 Ù†ÙØ± (Ù…Ú©Ø§Ù„Ù…Ù‡)</option>
                            <option value="1">1 Ù†ÙØ± (Ø¯Ø§Ø³ØªØ§Ù†ÛŒ)</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Ø·ÙˆÙ„ Ù…ØªÙ†</label>
                        <select id="scriptLength" class="w-full p-2 bg-gray-50 dark:bg-dark-input dark:text-white rounded-lg border border-gray-200 dark:border-gray-600 text-sm">
                            <option value="short">Ú©ÙˆØªØ§Ù‡ (~100 Ú©Ù„Ù…Ù‡)</option>
                            <option value="medium" selected>Ù…ØªÙˆØ³Ø· (~300 Ú©Ù„Ù…Ù‡)</option>
                            <option value="long">Ø·ÙˆÙ„Ø§Ù†ÛŒ (~600 Ú©Ù„Ù…Ù‡)</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateScript()" id="genScriptBtn" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700 transition flex items-center justify-center gap-2">
                    <span>Ù†ÙˆØ´ØªÙ† Ø³Ù†Ø§Ø±ÛŒÙˆ</span>
                    <i class="fa-solid fa-pen-nib"></i>
                    <div id="scriptLoader" class="loader hidden w-4 h-4"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0 px-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform border border-gray-100 dark:border-gray-700 flex flex-col max-h-[85vh]" id="settingsContent">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h2 class="text-lg font-bold text-gray-800 dark:text-white">ØªÙ†Ø¸ÛŒÙ…Ø§Øª API</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="space-y-2 flex-1 overflow-y-auto custom-scroll pr-1 mb-4 border-t border-b border-gray-100 dark:border-gray-700 py-2" id="keyList"></div>
            <div class="flex gap-2 shrink-0">
                <input type="text" id="newApiKey" placeholder="Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯..." class="flex-1 p-3 border dark:border-gray-600 dark:bg-dark-input dark:text-white rounded-lg text-sm bg-gray-50 ltr text-left font-mono">
                <button onclick="addApiKey()" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition shadow-md shadow-indigo-500/20"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-xl text-sm shadow-2xl opacity-0 pointer-events-none transition-opacity duration-300 z-50 text-center w-max max-w-[90%] font-medium flex items-center gap-2"></div>

    <script>
        const VOICES = [
            { name: "Kore", desc: "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒØŒ Ø´ÙØ§Ù" }, { name: "Zephyr", desc: "Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒØŒ Ú¯Ø±Ù…" }, { name: "Puck", desc: "Ù…Ø­Ú©Ù…" }, { name: "Fenrir", desc: "Ø¨Ø³ÛŒØ§Ø± Ø¨Ù…ØŒ ØªØ±ÛŒÙ„Ø±" }, { name: "Leda", desc: "Ø¢Ø±Ø§Ù… Ùˆ Ù…Ù„Ø§ÛŒÙ…" }, { name: "Aoede", desc: "Ø±Ø³Ø§ Ùˆ Ø¬Ø¯ÛŒ" }, { name: "Charon", desc: "Ø®Ø´Ù†" }, { name: "Orus", desc: "Ø¹Ø§Ø¯ÛŒ" }, { name: "Callirrhoe", desc: "Ø´Ø§Ø¯Ø§Ø¨" }, { name: "Enceladus", desc: "Ø§Ø®Ø¨Ø§Ø±" }, { name: "Algenib", desc: "ØªÙ†Ø¯ Ùˆ ØªÛŒØ²" }, { name: "Rasalgethi", desc: "Ù…Ú©Ø§Ù„Ù…Ù‡" }, { name: "Iapetus", desc: "Ø¬Ø¯ÛŒ" }, { name: "Autonoe", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Algieba", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Despina", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Erinome", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Laomedeia", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Pulcherrima", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Achird", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Vindemiatrix", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Sadachbia", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Achernar", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Alnilam", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Schedar", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Gacrux", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Zubenelgenubi", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Sadaltager", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Sulafat", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }, { name: "Umbriel", desc: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯" }
        ];

        const TONE_PRESETS = [
            { label: "Ø¹Ø§Ø¯ÛŒ", value: "", icon: "fa-regular fa-comment" }, { label: "Ø±Ø³Ù…ÛŒ/Ø®Ø¨Ø±ÛŒ", value: "Formal, Clear", icon: "fa-solid fa-bullhorn" }, { label: "Ú©ÙˆØ¯Ú©Ø§Ù†Ù‡", value: "Warm, Engaging", icon: "fa-solid fa-book-open" }, { label: "Ù‡ÛŒØ¬Ø§Ù†ÛŒ", value: "Excited, Fast", icon: "fa-regular fa-face-laugh-beam" }, { label: "ØºÙ…Ú¯ÛŒÙ†", value: "Sad, Slow", icon: "fa-regular fa-face-frown" }, { label: "Ø²Ù…Ø²Ù…Ù‡", value: "Whispering", icon: "fa-solid fa-ear-listen" }, { label: "Ø­Ù…Ø§Ø³ÛŒ", value: "Deep, Dramatic", icon: "fa-solid fa-film" }, { label: "Ø±Ø¨Ø§ØªÛŒÚ©", value: "Monotone, Flat", icon: "fa-solid fa-robot" }, { label: "Ù¾ÛŒØ±Ù…Ø±Ø¯/Ø²Ù†", value: "Shaky, Gravelly", icon: "fa-solid fa-user-clock" }
        ];

        let apiKeys = JSON.parse(localStorage.getItem('gemini_tts_keys') || '[]');
        let currentTheme = localStorage.getItem('gemini_theme') || 'light';
        let currentMode = 'single';
        let db;
        let activeChunks = [];
        let smartChunkMeta = []; // Stores {role, text} from smart split

        // App State
        let currentJobId = null;
        let isGenerating = false;
        let jobQueue = []; 
        let jobResults = [];
        let jobMode = "";

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error)); }

        window.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme); 
            populateVoiceList(); populateTonePresets(); renderApiKeys(); 
            initDB();
            setMode('single');
            if(apiKeys.length === 0) setTimeout(toggleSettings, 800);
        });

        function initDB() {
            const r = indexedDB.open("GeminiStudioDB", 2); 
            r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains("history")) e.target.result.createObjectStore("history", { keyPath: "id" }); };
            r.onsuccess = e => { db = e.target.result; loadHistory(); };
            r.onerror = e => { console.error("DB Error", e); showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³", true); };
        }

        function setMode(mode) {
            currentMode = mode;
            const indicator = document.getElementById('modeIndicator');
            const btnSingle = document.getElementById('modeBtn-single');
            const btnMulti = document.getElementById('modeBtn-multi');
            const singleVoice = document.getElementById('singleVoiceContainer');
            const globalTone = document.getElementById('globalToneSection');
            const multiInfo = document.getElementById('multiInfo');

            btnSingle.classList.remove('text-indigo-600', 'text-gray-500');
            btnMulti.classList.remove('text-indigo-600', 'text-gray-500');

            if (mode === 'single') {
                indicator.style.transform = 'translateX(0)';
                btnSingle.classList.add('text-indigo-600');
                btnMulti.classList.add('text-gray-500', 'dark:text-gray-400');
                singleVoice.classList.remove('hidden', 'opacity-0', 'h-0');
                globalTone.classList.remove('hidden');
                multiInfo.classList.add('hidden');
            } else {
                indicator.style.transform = 'translateX(-100%)';
                btnMulti.classList.add('text-indigo-600');
                btnSingle.classList.add('text-gray-500', 'dark:text-gray-400');
                singleVoice.classList.add('hidden', 'opacity-0', 'h-0');
                globalTone.classList.add('hidden'); // In multi, tone is per chunk
                multiInfo.classList.remove('hidden');
            }
        }

        function updateCounts() { 
            const val = document.getElementById('textInput').value;
            const chars = val.length;
            const words = val.trim() === '' ? 0 : val.trim().split(/\s+/).length;
            document.getElementById('charCount').textContent = `${chars} Ú©Ø§Ø±Ø§Ú©ØªØ± | ${words} Ú©Ù„Ù…Ù‡`; 
        }

        // --- SCRIPT WRITER WIZARD ---
        function openScriptWizard() {
            const m = document.getElementById('scriptModal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.remove('opacity-0', 'scale-95'), 10);
        }
        function closeScriptModal() {
            const m = document.getElementById('scriptModal');
            m.classList.add('opacity-0', 'scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }
        async function generateScript() {
            const topic = document.getElementById('scriptTopic').value.trim();
            const actors = document.getElementById('scriptActors').value;
            const len = document.getElementById('scriptLength').value;
            
            if(!topic) return showToast('Ù„Ø·ÙØ§Ù‹ Ù…ÙˆØ¶ÙˆØ¹ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', true);

            const btn = document.getElementById('genScriptBtn');
            const loader = document.getElementById('scriptLoader');
            btn.disabled = true; loader.classList.remove('hidden');

            let lenPrompt = "Keep it concise around 100 words.";
            if(len === 'medium') lenPrompt = "Write around 300 words.";
            if(len === 'long') lenPrompt = "Write a detailed script around 600 words.";

            try {
                await getWorkingKey(async (key) => {
                    const prompt = actors === '2' 
                        ? `Write a dialogue (script) in Persian about: "${topic}". ${lenPrompt} Format: Each speaker on a new line. Speaker A vs Speaker B. No metadata, just the lines.`
                        : `Write a story narration in Persian about: "${topic}". ${lenPrompt} Break it into paragraphs.`;

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const txt = (await r.json()).candidates[0].content.parts[0].text.trim();
                    
                    document.getElementById('textInput').value = txt;
                    updateCounts();
                    setMode(actors === '2' ? 'multi' : 'single');
                    closeScriptModal();
                    showToast('Ø³Ù†Ø§Ø±ÛŒÙˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
                });
            } catch (e) { showToast(e.message, true); }
            finally { btn.disabled = false; loader.classList.add('hidden'); }
        }

        // --- SMART CHUNKING LOGIC ---
        async function smartSplitStory() {
            const text = document.getElementById('textInput').value.trim();
            if(!text) return showToast('Ù…ØªÙ†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', true);

            const btn = document.getElementById('smartSplitBtn');
            const loader = document.getElementById('smartLoader');
            btn.disabled = true; loader.classList.remove('hidden');
            
            try {
                await getWorkingKey(async (key) => {
                    const prompt = `Analyze this Persian story. Split it into parts based on who is speaking (Narrator vs Characters). Identify the speaker for each part. 
                    Return a JSON Array ONLY. Format: [{"role": "SpeakerName", "text": "..."}]. 
                    Merge consecutive lines by same speaker. Do NOT translate. Keep exact Persian text.
                    Text:
                    ${text.substring(0, 8000)}`; 

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    }) });
                    
                    const data = await r.json();
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    if(Array.isArray(result) && result.length > 0) {
                        smartChunkMeta = result; 
                        activeChunks = result.map(i => i.text); 
                        
                        document.getElementById('chunkSlider').value = result.length;
                        document.getElementById('chunkCountDisplay').textContent = result.length + " (AI)";
                        
                        renderChunks(true); 
                        showToast('ØªÙÚ©ÛŒÚ© Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ğŸª„');
                    } else {
                        throw new Error("Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯");
                    }
                });
            } catch (e) {
                console.error(e);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯: ' + e.message, true);
            } finally {
                btn.disabled = false; loader.classList.add('hidden');
            }
        }

        // --- STANDARD CHUNKING LOGIC ---
        function splitText(text, count) {
            let chunks = [];
            
            if (currentMode === 'multi') {
                const lines = text.split(/\n+/).filter(l => l.trim().length > 0);
                if (lines.length >= count) {
                    const perChunk = Math.ceil(lines.length / count);
                    for (let i = 0; i < lines.length; i += perChunk) {
                        chunks.push(lines.slice(i, i + perChunk).join(' '));
                    }
                    return chunks.slice(0, count);
                }
            }
            if (count === 1) return [text];
            const sentences = text.match(/[^.?!ØŸ\n]+[.?!ØŸ\n]*/g) || [text];
            const totalLen = text.length; const avgLen = totalLen / count;
            let currentChunk = "";
            chunks = [];
            for (let s of sentences) {
                if ((currentChunk.length + s.length) > avgLen && chunks.length < count - 1) { chunks.push(currentChunk.trim()); currentChunk = s; } else { currentChunk += s; }
            }
            if (currentChunk.trim()) chunks.push(currentChunk.trim());
            return chunks;
        }

        function prepareGeneration() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) { showToast('Ù…ØªÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', true); return; }
            if (isGenerating) { showToast('Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ¹Ù„ÛŒ ØªÙ…Ø§Ù… Ø´ÙˆØ¯', true); return; }

            const modal = document.getElementById('chunkModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0', 'scale-95'), 10);

            smartChunkMeta = []; 

            let initialCount = 1;
            if (currentMode === 'multi') {
                 initialCount = Math.min(20, Math.max(2, text.split(/\n+/).length));
            } else {
                 if (text.length > 300) initialCount = Math.ceil(text.length / 300);
            }
            
            const slider = document.getElementById('chunkSlider');
            slider.value = initialCount;
            slider.max = Math.max(10, Math.ceil(text.length / 50) + 1);
            updateChunkingFromSlider(initialCount);
        }

        function updateChunkingFromSlider(val) {
            document.getElementById('chunkCountDisplay').textContent = val;
            const text = document.getElementById('textInput').value.trim();
            smartChunkMeta = []; 
            activeChunks = splitText(text, parseInt(val));
            renderChunks(false);
        }

        function renderChunks(isSmart = false) {
            const container = document.getElementById('chunksContainer');
            container.innerHTML = '';
            
            const globalVoice = document.getElementById('voiceSelect').value;
            VOICES.sort((a,b)=>a.name.localeCompare(b.name));

            let roleToVoiceMap = {};
            let availableVoices = [...VOICES].filter(v => v.name !== "Kore"); 
            let voiceIndex = 0;

            activeChunks.forEach((chunkText, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-dark-input rounded-xl p-3 border border-gray-200 dark:border-gray-600 shadow-sm animate-fade-in group relative focus-within:ring-2 focus-within:ring-indigo-400";
                
                let defaultVoice = globalVoice;
                let roleName = "Ø¨Ø®Ø´ " + (idx + 1);
                
                if (isSmart && smartChunkMeta[idx]) {
                    const meta = smartChunkMeta[idx];
                    roleName = meta.role;
                    
                    if (roleName.includes("Ø±Ø§ÙˆÛŒ") || roleName.toLowerCase().includes("narrator")) {
                        defaultVoice = "Kore";
                    } else {
                        if (!roleToVoiceMap[roleName]) {
                            if (voiceIndex < availableVoices.length) {
                                roleToVoiceMap[roleName] = availableVoices[voiceIndex].name;
                                voiceIndex++;
                            } else {
                                roleToVoiceMap[roleName] = "Fenrir"; 
                            }
                        }
                        defaultVoice = roleToVoiceMap[roleName];
                    }
                } else if(currentMode === 'multi') { 
                    if (idx % 2 === 0) defaultVoice = "Kore";
                    else defaultVoice = "Fenrir"; 
                }

                let optionsHtml = VOICES.map(v => `<option value="${v.name}" ${v.name === defaultVoice ? 'selected' : ''}>${v.name}</option>`).join('');
                
                const badgeHtml = isSmart ? `<span class="role-badge"><i class="fa-solid fa-user-tag text-[8px]"></i> ${roleName}</span>` : `<span class="text-[10px] text-gray-400 shrink-0 font-bold bg-gray-100 dark:bg-gray-700 px-2 rounded-md">${roleName}</span>`;

                div.innerHTML = `
                    <div class="flex flex-col gap-2 mb-2">
                        <div class="flex justify-between items-center">
                            ${badgeHtml}
                            <div class="flex gap-1 flex-1 justify-end">
                                <input type="text" class="chunk-tone-input text-xs bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600 rounded-lg py-1 px-2 w-1/3 outline-none focus:border-indigo-500 placeholder:text-gray-400 text-left font-mono" placeholder="Ù„Ø­Ù† (Sad...)" value="${currentMode === 'single' ? '' : ''}">
                                <select class="chunk-voice-select text-xs bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-200 border-none rounded-lg py-1 px-2 cursor-pointer focus:ring-1 focus:ring-indigo-500 font-bold max-w-[100px]">${optionsHtml}</select>
                            </div>
                        </div>
                    </div>
                    <textarea class="chunk-editor w-full bg-transparent border-none outline-none resize-none text-sm text-gray-700 dark:text-gray-200 leading-6 font-medium border-t border-gray-100 dark:border-gray-700 pt-2" rows="3" oninput="activeChunks[${idx}] = this.value">${chunkText}</textarea>
                `;
                container.appendChild(div);
            });
        }

        function closeChunkModal() {
            const modal = document.getElementById('chunkModal');
            modal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- GENERATION LOGIC ---
        
        async function startJobInUI() {
            const editors = document.querySelectorAll('.chunk-editor');
            const voiceSelects = document.querySelectorAll('.chunk-voice-select');
            const toneInputs = document.querySelectorAll('.chunk-tone-input');
            
            jobQueue = [];
            jobResults = new Array(editors.length).fill(null);
            
            const globalTone = document.getElementById('toneInput').value.trim();
            jobMode = currentMode;
            currentJobId = Date.now();
            const fullText = Array.from(editors).map(e => e.value.trim()).join('\n');

            editors.forEach((ed, i) => {
                const txt = ed.value.trim();
                const v = voiceSelects[i].value;
                let t = toneInputs[i].value.trim();
                if(!t && currentMode === 'single') t = globalTone;

                if(txt) jobQueue.push({ text: txt, voice: v, tone: t, index: i });
            });

            closeChunkModal();
            isGenerating = true;

            const historyList = document.getElementById('historyList');
            const projectDiv = document.createElement('div');
            projectDiv.id = `project-${currentJobId}`;
            projectDiv.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl border border-indigo-200 dark:border-indigo-900 shadow-md flex flex-col gap-4 animate-fade-in relative overflow-hidden";
            
            projectDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1 overflow-hidden">
                        <div class="flex items-center gap-2 mb-1" id="status-badge-${currentJobId}">
                            <i class="fa-solid fa-bolt text-yellow-500 animate-pulse"></i>
                            <span class="text-[10px] bg-indigo-50 dark:bg-indigo-900 px-2 rounded-full text-indigo-600 dark:text-indigo-300">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯...</span>
                        </div>
                        <p class="text-xs font-bold text-gray-800 dark:text-gray-200 truncate" dir="auto">${fullText}</p>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-black/20 rounded-xl p-3 flex flex-col gap-2 opacity-50 pointer-events-none" id="main-player-${currentJobId}">
                    <div class="text-center text-xs text-gray-400 py-2">Ù…ÛŒÚ©Ø³ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø³ Ø§Ø² ØªÚ©Ù…ÛŒÙ„ ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                </div>

                <div class="space-y-2" id="parts-container-${currentJobId}">
                    ${jobQueue.map(task => `
                        <div id="part-row-${currentJobId}-${task.index}" class="flex items-center gap-3 p-2 rounded-lg border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 transition-all">
                            <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center shrink-0">
                                <i class="fa-solid fa-spinner fa-spin text-gray-400 text-xs" id="part-icon-${currentJobId}-${task.index}"></i>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mb-0.5">${task.voice} ${task.tone ? `<span class="text-indigo-400">(${task.tone})</span>` : ''}</p>
                                <p class="text-xs text-gray-700 dark:text-gray-300 truncate">${task.text}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            if(historyList.firstChild) historyList.insertBefore(projectDiv, historyList.firstChild);
            else historyList.appendChild(projectDiv);

            processQueueUI();
        }

        async function processQueueUI() {
            if (jobQueue.length === 0) { 
                setTimeout(finalizeJobUI, 500); 
                return; 
            }
            const task = jobQueue.shift();
            
            const icon = document.getElementById(`part-icon-${currentJobId}-${task.index}`);
            if(icon) icon.className = "fa-solid fa-circle-notch fa-spin text-indigo-500 text-xs";

            try {
                let prompt = task.text;
                if (task.tone) prompt = `(Style: ${task.tone}) ${task.text}`;
                
                const blob = await getAudioFromAPI(prompt, task.voice);
                const duration = await getBlobDuration(blob);

                const partData = { blob: blob, voice: task.voice, text: task.text, tone: task.tone, duration: duration };
                jobResults[task.index] = partData;
                updatePartUI(task.index, partData);
            } catch (e) {
                console.error(e);
                showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø®Ø´ ${task.index + 1}: ${e.message}`, true);
                if(icon) icon.className = "fa-solid fa-triangle-exclamation text-red-500 text-xs";
                jobResults[task.index] = { failed: true, text: task.text };
            } finally {
                setTimeout(processQueueUI, 300);
            }
        }

        function getBlobDuration(blob) {
            return new Promise(resolve => {
                const tempAudio = new Audio(URL.createObjectURL(blob));
                tempAudio.onloadedmetadata = () => {
                    if(tempAudio.duration === Infinity) {
                        tempAudio.currentTime = 1e101;
                        tempAudio.ontimeupdate = function() {
                            this.ontimeupdate = null;
                            resolve(this.duration); 
                            this.currentTime = 0;
                        }
                    } else {
                        resolve(tempAudio.duration);
                    }
                };
                setTimeout(() => resolve(0), 2000); 
            });
        }

        function updatePartUI(index, partData) {
            const row = document.getElementById(`part-row-${currentJobId}-${index}`);
            if(!row) return;

            const url = URL.createObjectURL(partData.blob);
            row.className = "part-row flex items-center gap-3 p-2 rounded-lg border border-indigo-100 dark:border-indigo-900 bg-white dark:bg-gray-700 transition-all shadow-sm";
            row.id = `part-row-${currentJobId}-${index}`; 
            row.innerHTML = `
                <button onclick="playSinglePart(this, '${url}')" class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 flex items-center justify-center shrink-0 hover:bg-indigo-600 hover:text-white transition group">
                    <i class="fa-solid fa-play text-[10px] ml-0.5"></i>
                </button>
                <div class="flex-1 overflow-hidden">
                    <div class="flex justify-between items-center mb-0.5">
                        <div class="flex items-center gap-2">
                             <p class="text-[10px] text-indigo-500 font-bold">${partData.voice}</p>
                             <span class="text-[9px] bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 px-1.5 rounded-md font-mono">${formatTime(partData.duration)}</span>
                        </div>
                        <a href="${url}" download="part_${index+1}.wav" class="text-gray-300 hover:text-gray-500 px-1"><i class="fa-solid fa-download text-[10px]"></i></a>
                    </div>
                    <p class="text-xs text-gray-700 dark:text-gray-300 truncate" dir="auto">${partData.text}</p>
                </div>
            `;
        }

        async function finalizeJobUI() {
            try {
                const validParts = jobResults.filter(r => r && !r.failed);
                if (validParts.length === 0) { 
                    throw new Error("Ù‡ÛŒÚ† Ø¨Ø®Ø´ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ù†Ø´Ø¯."); 
                }

                // Visual update
                const badge = document.getElementById(`status-badge-${currentJobId}`);
                if(badge) badge.innerHTML = `<i class="fa-solid fa-rotate fa-spin text-blue-500"></i><span class="text-[10px] text-blue-500">Ù…ÛŒÚ©Ø³ Ù†Ù‡Ø§ÛŒÛŒ...</span>`;

                const audioBuffers = await Promise.all(validParts.map(p => p.blob.arrayBuffer()));
                const mergedBuffer = mergeAudioBuffers(audioBuffers);
                const mergedBlob = new Blob([mergedBuffer], { type: 'audio/wav' });

                const fullText = validParts.map(p => p.text).join('\n\n');
                
                saveToHistory(fullText, jobResults, jobMode, mergedBlob);

            } catch (e) {
                console.error("Finalization Error:", e);
                showToast(e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ©Ø³ Ù†Ù‡Ø§ÛŒÛŒ', true);
                isGenerating = false;
                const badge = document.getElementById(`status-badge-${currentJobId}`);
                if(badge) badge.innerHTML = `<i class="fa-solid fa-circle-xmark text-red-500"></i><span class="text-[10px] text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ©Ø³</span>`;
            }
        }

        function mergeAudioBuffers(buffers) {
            if (buffers.length === 0) return new ArrayBuffer(0);
            if (buffers.length === 1) return buffers[0];
            
            const header = buffers[0].slice(0, 44);
            const dataLength = buffers.reduce((acc, b) => acc + b.byteLength - 44, 0);
            const totalLength = dataLength + 36; 

            const result = new Uint8Array(44 + dataLength);
            result.set(new Uint8Array(header), 0);
            
            const view = new DataView(result.buffer);
            view.setUint32(4, totalLength, true); 
            view.setUint32(40, dataLength, true); 

            let offset = 44;
            for (const buffer of buffers) {
                const data = new Uint8Array(buffer).subarray(44);
                result.set(data, offset);
                offset += data.length;
            }

            return result.buffer;
        }

        function saveToHistory(fullText, parts, mode, mergedBlob) {
            if(!db) return;
            let currentTime = 0;
            const partsWithTiming = parts.map(p => {
                if(p.failed) return p;
                const start = currentTime;
                currentTime += (p.duration || 0);
                return { ...p, startTime: start, endTime: currentTime };
            });

            const t = db.transaction(["history"], "readwrite");
            
            t.onerror = (event) => {
                console.error("Save Error:", event);
                isGenerating = false;
                const url = URL.createObjectURL(mergedBlob);
                const badge = document.getElementById(`status-badge-${currentJobId}`);
                if(badge) {
                    badge.innerHTML = `<a href="${url}" download="mix_rescue.wav" class="bg-red-500 text-white px-2 py-1 rounded text-[10px]">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ (Ø­Ø§ÙØ¸Ù‡ Ù¾Ø± Ø§Ø³Øª)</a>`;
                }
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡. Ø­Ø§ÙØ¸Ù‡ Ù¾Ø± Ø§Ø³Øª!", true);
            };

            const req = t.objectStore("history").add({ 
                id: Date.now(), 
                fullText, parts: partsWithTiming, mode, 
                mergedBlob: mergedBlob, 
                date: new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) 
            });

            t.oncomplete = () => { 
                isGenerating = false; 
                showToast('Ù¾Ø±ÙˆÚ˜Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…ÛŒÚ©Ø³ Ø´Ø¯'); 
                loadHistory(); 
            };
        }

        function downloadAsMp3(blob, filename) {
             showToast('Ø¯Ø± Ø­Ø§Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ MP3...', false);
             const reader = new FileReader();
             reader.onload = function(e) {
                 const wavData = new Int16Array(e.target.result.slice(44)); 
                 const mp3Data = [];
                 const samples = wavData; 
                 const mp3encoder = new lamejs.Mp3Encoder(1, 24000, 128); 
                 const remaining = samples.length;
                 const maxSamples = 1152;
                 for (let i = 0; i < remaining; i += maxSamples) {
                     const mono = samples.subarray(i, i + maxSamples);
                     const mp3buf = mp3encoder.encodeBuffer(mono);
                     if (mp3buf.length > 0) mp3Data.push(mp3buf);
                 }
                 const d = mp3encoder.flush();
                 if(d.length > 0) mp3Data.push(d);
                 const mp3Blob = new Blob(mp3Data, {type: 'audio/mp3'});
                 const a = document.createElement('a');
                 a.href = URL.createObjectURL(mp3Blob); a.download = filename; a.click();
                 showToast('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
             };
             reader.readAsArrayBuffer(blob);
        }

        function loadHistory() {
            if (!db) return;
            const r = db.transaction(["history"], "readonly").objectStore("history").getAll();
            r.onsuccess = () => {
                const list = document.getElementById('historyList'); list.innerHTML = '';
                const items = r.result.sort((a,b) => b.id - a.id);
                if(items.length === 0) { list.innerHTML = '<div class="text-xs text-gray-400 text-center py-6 opacity-50">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>'; return; }
                
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col gap-4 animate-fade-in group";
                    const isMulti = item.mode === 'multi';
                    const modeIcon = isMulti ? '<i class="fa-solid fa-users-rays text-pink-500"></i>' : '<i class="fa-solid fa-user text-indigo-500"></i>';
                    
                    const mergedUrl = item.mergedBlob ? URL.createObjectURL(item.mergedBlob) : null;
                    
                    // Calculate Total Duration
                    const totalDuration = item.parts.reduce((acc, p) => acc + (p.duration || 0), 0);
                    const formattedTotal = formatTime(totalDuration);

                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 overflow-hidden">
                                <div class="flex items-center gap-2 mb-1">${modeIcon}<span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 rounded-full text-gray-500">${item.parts.length} Ø¨Ø®Ø´</span><span class="text-[10px] text-gray-400">${item.date}</span></div>
                                <p class="text-xs font-bold text-gray-800 dark:text-gray-200 truncate" dir="auto">${item.fullText.substring(0, 50)}...</p>
                            </div>
                            <button onclick="delHist(${item.id})" class="text-gray-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                        </div>

                        ${mergedUrl ? `
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-3 flex flex-col gap-2 relative overflow-hidden">
                            <div class="flex justify-between items-center mb-1 relative z-10">
                                <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-1"><i class="fa-solid fa-music"></i> Ù…ÛŒÚ©Ø³ Ù†Ù‡Ø§ÛŒÛŒ <span class="bg-indigo-200 dark:bg-indigo-800 text-indigo-800 dark:text-indigo-200 px-1.5 rounded-md text-[9px] font-mono">${formattedTotal}</span></span>
                                <div class="flex gap-2">
                                     <button onclick="downloadAsMp3(retrieveBlob(${item.id}), 'mix_${item.id}.mp3')" class="text-[10px] bg-white dark:bg-indigo-800 px-2 py-0.5 rounded border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-300 hover:bg-indigo-600 hover:text-white transition">MP3</button>
                                     <a href="${mergedUrl}" download="mix_${item.id}.wav" class="text-[10px] bg-white dark:bg-indigo-800 px-2 py-0.5 rounded border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-300 hover:bg-indigo-600 hover:text-white transition">WAV</a>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 relative z-10">
                                <button onclick="toggleMainPlay('${mergedUrl}', this, ${item.id})" id="mainPlay-${item.id}" class="w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center shrink-0 shadow-lg shadow-indigo-500/30 transition"><i class="fa-solid fa-play ml-0.5"></i></button>
                                <div class="flex-1 flex flex-col justify-center">
                                    <input type="range" id="seek-${item.id}" min="0" max="100" value="0" step="0.1" class="w-full" oninput="seekMain(${item.id}, this.value)">
                                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                                        <span id="time-${item.id}">0:00</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] opacity-60">Karaoke Active</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>` : ''}

                        <div class="space-y-1.5 max-h-60 overflow-y-auto custom-scroll pr-1" id="parts-list-${item.id}">
                            ${item.parts.map((part, i) => {
                                if(part.failed) return `<div class="text-xs text-red-400 p-2">Ø¨Ø®Ø´ ${i+1} Ø®Ø·Ø§ Ø¯Ø§Ø´Øª</div>`;
                                const pUrl = URL.createObjectURL(part.blob);
                                const duration = formatTime(part.duration || 0);
                                return `
                                <div id="part-item-${item.id}-${i}" class="part-item flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 border border-transparent hover:border-gray-100 transition-all group/part">
                                    <button onclick="playSinglePart(this, '${pUrl}')" class="w-7 h-7 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 flex items-center justify-center shrink-0 hover:bg-indigo-500 hover:text-white transition">
                                        <i class="fa-solid fa-play text-[9px] ml-0.5"></i>
                                    </button>
                                    <div class="flex-1 overflow-hidden">
                                        <div class="flex justify-between items-center mb-0.5">
                                            <div class="flex items-center gap-2">
                                                <p class="text-[9px] text-gray-400 font-bold flex gap-1 items-center">
                                                    ${part.voice} 
                                                    ${part.tone ? `<span class="bg-indigo-50 dark:bg-indigo-900/50 text-indigo-500 px-1 rounded">${part.tone}</span>` : ''}
                                                </p>
                                                <span class="text-[9px] bg-gray-100 dark:bg-gray-600 text-gray-500 dark:text-gray-300 px-1.5 rounded-md font-mono">${duration}</span>
                                            </div>
                                            <span class="text-[9px] opacity-50 text-gray-400">#${i+1}</span>
                                        </div>
                                        <p class="text-[11px] text-gray-600 dark:text-gray-300 truncate" dir="auto">${part.text}</p>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                    list.appendChild(div);
                    div.dataset.parts = JSON.stringify(item.parts.map(p => ({start: p.startTime, end: p.endTime})));
                });
            };
        }

        function retrieveBlob(id) {
             const h = document.getElementById(`mainPlay-${id}`);
             return null; 
        }
        window.downloadAsMp3 = function(blobOrNull, name) {
             const id = parseInt(name.split('_')[1]);
             const req = db.transaction(["history"], "readonly").objectStore("history").get(id);
             req.onsuccess = () => {
                 if(req.result && req.result.mergedBlob) {
                     downloadAsMp3Internal(req.result.mergedBlob, name);
                 }
             }
        }
        function downloadAsMp3Internal(blob, filename) {
             showToast('Ø¯Ø± Ø­Ø§Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ MP3...', false);
             const reader = new FileReader();
             reader.onload = function(e) {
                 const wavData = new Int16Array(e.target.result.slice(44)); 
                 const mp3Data = [];
                 const samples = wavData; 
                 const mp3encoder = new lamejs.Mp3Encoder(1, 24000, 128); 
                 const remaining = samples.length;
                 const maxSamples = 1152;
                 for (let i = 0; i < remaining; i += maxSamples) {
                     const mono = samples.subarray(i, i + maxSamples);
                     const mp3buf = mp3encoder.encodeBuffer(mono);
                     if (mp3buf.length > 0) mp3Data.push(mp3buf);
                 }
                 const d = mp3encoder.flush();
                 if(d.length > 0) mp3Data.push(d);
                 const mp3Blob = new Blob(mp3Data, {type: 'audio/mp3'});
                 const a = document.createElement('a');
                 a.href = URL.createObjectURL(mp3Blob); a.download = filename; a.click();
                 showToast('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
             };
             reader.readAsArrayBuffer(blob);
        }

        // --- PLAYBACK ENGINES ---
        let mainAudio = new Audio();
        let currentMainId = null;
        let animationFrameId;

        function toggleMainPlay(url, btn, id) {
            const icon = btn.querySelector('i');
            const partsList = document.getElementById(`parts-list-${id}`);
            const partsMeta = partsList.parentElement.dataset.parts ? JSON.parse(partsList.parentElement.dataset.parts) : [];

            if (currentMainId === id && !mainAudio.paused) {
                mainAudio.pause();
                icon.className = 'fa-solid fa-play ml-0.5';
                cancelAnimationFrame(animationFrameId);
                return;
            }
            
            if (currentMainId === id && mainAudio.paused) {
                if(!singleAudio.paused) singleAudio.pause();
                mainAudio.play();
                icon.className = 'fa-solid fa-pause';
                karaokeLoop(id, partsMeta);
                return;
            }

            mainAudio.pause();
            cancelAnimationFrame(animationFrameId);
            
            document.querySelectorAll('.karaoke-active').forEach(el => el.classList.remove('karaoke-active'));
            if(currentMainId !== null) {
                const prevBtn = document.getElementById(`mainPlay-${currentMainId}`);
                if(prevBtn) prevBtn.querySelector('i').className = 'fa-solid fa-play ml-0.5';
            }
            
            mainAudio.src = url;
            currentMainId = id;
            
            const seekBar = document.getElementById(`seek-${id}`);
            const timeDisplay = document.getElementById(`time-${id}`);
            
            mainAudio.onloadedmetadata = () => { seekBar.max = mainAudio.duration; };
            mainAudio.onended = () => { 
                icon.className = 'fa-solid fa-play ml-0.5'; 
                seekBar.value = 0; 
                cancelAnimationFrame(animationFrameId);
                document.querySelectorAll('.karaoke-active').forEach(el => el.classList.remove('karaoke-active'));
            };
            
            mainAudio.play();
            icon.className = 'fa-solid fa-pause';
            karaokeLoop(id, partsMeta);
        }

        function karaokeLoop(id, parts) {
            const seekBar = document.getElementById(`seek-${id}`);
            const timeDisplay = document.getElementById(`time-${id}`);
            
            const update = () => {
                if(mainAudio.paused || currentMainId !== id) return;
                
                const t = mainAudio.currentTime;
                seekBar.value = t;
                timeDisplay.textContent = formatTime(t);

                parts.forEach((p, idx) => {
                    const el = document.getElementById(`part-item-${id}-${idx}`);
                    if (el) {
                        if (t >= p.start && t < p.end) {
                            if(!el.classList.contains('karaoke-active')) {
                                document.querySelectorAll(`#parts-list-${id} .karaoke-active`).forEach(e => e.classList.remove('karaoke-active'));
                                el.classList.add('karaoke-active');
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }
                });

                animationFrameId = requestAnimationFrame(update);
            };
            update();
        }

        function seekMain(id, val) {
            if (currentMainId === id) mainAudio.currentTime = val;
        }

        // --- SINGLE PART PLAYER ---
        let singleAudio = new Audio();
        let currentSingleBtn = null;

        function playSinglePart(btn, url) {
            const icon = btn.querySelector('i');
            if (singleAudio.src === url) {
                if (!singleAudio.paused) {
                    singleAudio.pause();
                    icon.className = 'fa-solid fa-play text-[9px] ml-0.5';
                } else {
                    if (!mainAudio.paused) mainAudio.pause();
                    singleAudio.play();
                    icon.className = 'fa-solid fa-pause text-[9px]';
                }
                return;
            }
            if (currentSingleBtn && currentSingleBtn !== btn) currentSingleBtn.querySelector('i').className = 'fa-solid fa-play text-[9px] ml-0.5';
            if (!mainAudio.paused) {
                 mainAudio.pause();
                 if(currentMainId) document.getElementById(`mainPlay-${currentMainId}`).querySelector('i').className = 'fa-solid fa-play ml-0.5';
            }
            singleAudio.src = url;
            singleAudio.play();
            currentSingleBtn = btn;
            icon.className = 'fa-solid fa-pause text-[9px]';
            singleAudio.onended = () => { icon.className = 'fa-solid fa-play text-[9px] ml-0.5'; currentSingleBtn = null; };
        }

        function formatTime(s) {
            if(isNaN(s)) return "0:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        function toggleVoiceList() { const l=document.getElementById('voiceListContainer'),a=document.getElementById('voiceArrow'),o=l.classList.contains('open'); l.classList.toggle('open'); a.style.transform=!o?'rotate(180deg)':'rotate(0deg)'; }
        function populateVoiceList() { 
            const c=document.getElementById('voiceListInner'),h=document.getElementById('voiceSelect'); c.innerHTML=''; 
            VOICES.sort((a,b)=>a.name.localeCompare(b.name));
            VOICES.forEach(v=>{ const i=document.createElement('div'),s=v.name===h.value; i.className=`voice-item p-2 rounded-lg cursor-pointer flex justify-between items-center transition border border-transparent hover:bg-gray-100 dark:hover:bg-gray-700 ${s?'selected':''}`; i.onclick=(e)=>{if(e.target.closest('.test-btn'))return;document.getElementById('voiceSelect').value=v.name;document.getElementById('selectedVoiceName').textContent=v.name;document.getElementById('selectedVoiceDesc').textContent=`(${v.desc})`;toggleVoiceList();populateVoiceList();}; i.innerHTML=`<div class="flex items-center gap-2"><span class="text-sm font-bold text-gray-700 dark:text-gray-300 font-mono">${v.name}</span><span class="text-xs text-gray-400">(${v.desc})</span></div><button class="test-btn p-1.5 rounded-full text-indigo-500 hover:bg-indigo-100 dark:bg-opacity-20 transition flex items-center justify-center w-7 h-7" title="ØªØ³Øª ØµØ¯Ø§" onclick="testVoice('${v.name}',this)"><i class="fa-solid fa-play text-[10px]"></i></button>`; c.appendChild(i);}); 
        }
        function populateTonePresets() { const c=document.getElementById('tonePresets'); TONE_PRESETS.forEach(t=>{const b=document.createElement('button');b.className="snap-start shrink-0 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-[11px] text-gray-600 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition flex items-center gap-2 shadow-sm min-w-[max-content]";b.innerHTML=`<i class="${t.icon}"></i> ${t.label}`;b.onclick=()=>{document.getElementById('toneInput').value=t.value;};c.appendChild(b);});c.appendChild(document.createElement('div')).className="w-4 shrink-0"; }
        
        async function getAudioFromAPI(text, voice) {
            return await getWorkingKey(async (key) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
                const payload = { contents: [{ parts: [{ text: text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } } } };
                const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const binary = window.atob(b64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const wav = pcmToWav(bytes, 24000); 
                return new Blob([wav], { type: 'audio/wav' });
            });
        }
        function pcmToWav(p,r){const b=new ArrayBuffer(44+p.length),v=new DataView(b),w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};w(0,'RIFF');v.setUint32(4,36+p.length,true);w(8,'WAVE');w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,r,true);v.setUint32(28,r*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);w(36,'data');v.setUint32(40,p.length,true);new Uint8Array(b).set(p,44);return b;}
        
        async function getWorkingKey(fn) { if (apiKeys.length === 0) { showToast('Ú©Ù„ÛŒØ¯ API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', true); toggleSettings(); return null; } for (const k of apiKeys) { try { return await fn(k); } catch (e) { continue; } } throw new Error('Ù‡Ù…Ù‡ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø®Ø·Ø§ Ø¯Ø§Ø±Ù†Ø¯.'); }
        async function testVoice(v,b) { const oi=b.innerHTML; b.innerHTML='<i class="fa-solid fa-spinner fa-spin text-[10px]"></i>'; b.disabled=true; try { await getAudioFromAPI("ØªØ³Øª", v).then(blob => { new Audio(URL.createObjectURL(blob)).play(); }); } catch (e) { showToast("Ø®Ø·Ø§: " + e.message, true); } finally { b.innerHTML = oi; b.disabled = false; } }
        async function enhanceTone() { const i=document.getElementById('toneInput'),t=i.value.trim();if(!t){showToast('ØªÙˆØµÛŒÙÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯',true);return;}const b=document.getElementById('enhanceBtn'),ic=b.querySelector('i'),l=document.getElementById('enhanceLoader');b.disabled=true;ic.classList.add('hidden');l.classList.remove('hidden');try{await getWorkingKey(async(k)=>{const u=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`,r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`Convert user description to 3-4 English adjectives for a TTS voice style. NO sentences. Input: "${t}"`}]}]})}),x=(await r.json()).candidates[0].content.parts[0].text.trim().replace(/\.$/,'');i.value=x;showToast('Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯ âœ¨');});}catch(e){showToast(e.message,true);}finally{b.disabled=false;ic.classList.remove('hidden');l.classList.add('hidden');} }
        async function autoDiacritics() { const i=document.getElementById('textInput'),t=i.value.trim();if(!t)return;const b=document.getElementById('diacriticBtn'),l=document.getElementById('diacriticLoader'),ic=b.querySelector('.fa-spell-check');b.disabled=true;ic.classList.add('hidden');l.classList.remove('hidden');try{await getWorkingKey(async(k)=>{const u=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`,r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`Add minimal diacritics (harakat) to this Persian text. Kasra for Ezafe is priority. Output ONLY text. Input: ${t}`}]}]})});i.value=(await r.json()).candidates[0].content.parts[0].text.trim();showToast('Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');});}catch(e){showToast(e.message,true);}finally{b.disabled=false;ic.classList.remove('hidden');l.classList.add('hidden');} }
        function delHist(id) { if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){const t=db.transaction(["history"],"readwrite");t.objectStore("history").delete(id);t.oncomplete=loadHistory;} }
        function clearHistory() { if(confirm('Ù‡Ù…Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')){const t=db.transaction(["history"],"readwrite");t.objectStore("history").clear();t.oncomplete=loadHistory;} }
        function applyTheme(t){localStorage.setItem('gemini_theme',t);document.documentElement.classList.toggle('dark',t==='dark');document.getElementById('themeIcon').className=t==='dark'?'fa-solid fa-sun text-yellow-400':'fa-solid fa-moon';}
        function toggleTheme(){applyTheme(document.documentElement.classList.contains('dark')?'light':'dark');}
        function toggleSettings(){const m=document.getElementById('settingsModal');m.classList.toggle('hidden');setTimeout(()=>m.classList.toggle('opacity-0'),10);}
        function showToast(m,e){const t=document.getElementById('toast');t.innerHTML=(e?'<i class="fa-solid fa-circle-exclamation text-red-300"></i> ':'<i class="fa-solid fa-circle-check text-green-300"></i> ')+m;t.className=`fixed bottom-24 left-1/2 -translate-x-1/2 px-5 py-3 rounded-xl text-sm shadow-2xl z-50 flex items-center gap-2 font-medium transition-all duration-300 ${e?'bg-red-600 text-white':'bg-gray-800 text-white'}`;t.style.opacity='1';setTimeout(()=>t.style.opacity='0',3000);}
        function renderApiKeys(){const l=document.getElementById('keyList');l.innerHTML='';if(apiKeys.length===0){l.innerHTML='<div class="text-center text-gray-400 text-xs py-4">Ù‡Ù†ÙˆØ² Ú©Ù„ÛŒØ¯ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';}apiKeys.forEach((k,i)=>{const d=document.createElement('div');d.className='flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg border border-gray-100 dark:border-gray-600';d.innerHTML=`<div class="flex-1 overflow-hidden mr-2 relative"><input type="password" id="key-${i}" value="${k}" readonly class="w-full bg-transparent border-none outline-none text-[10px] font-mono text-gray-600 dark:text-gray-300 h-6"></div><div class="flex items-center gap-1"><button onclick="toggleVis(${i})" class="text-gray-400 hover:text-indigo-500 p-1.5 rounded"><i id="eye-${i}" class="fa-solid fa-eye"></i></button><button onclick="rmKey(${i})" class="text-red-300 hover:text-red-500 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button></div>`;l.appendChild(d);});document.getElementById('noKeyBadge').classList.toggle('hidden',apiKeys.length>0);}
        function toggleVis(i){const p=document.getElementById(`key-${i}`),c=document.getElementById(`eye-${i}`);if(p.type==='password'){p.type='text';c.className='fa-solid fa-eye-slash';}else{p.type='password';c.className='fa-solid fa-eye';}}
        function addApiKey(){const i=document.getElementById('newApiKey'),v=i.value.trim();if(v){apiKeys.push(v);localStorage.setItem('gemini_tts_keys',JSON.stringify(apiKeys));i.value='';renderApiKeys();showToast('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');}}
        function rmKey(i){if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){apiKeys.splice(i,1);localStorage.setItem('gemini_tts_keys',JSON.stringify(apiKeys));renderApiKeys();}}
    </script>
</body>
</html>


